### âœï¸ Tangxt â³ 2021-02-27 ğŸ·ï¸ å¯å“åº”å¯¹è±¡

# 07-å¯å“åº”å¯¹è±¡-2

1ï¼‰è®¾ç½®å€¼ï¼Œè§¦å‘é‡æ–°æ¸²æŸ“

ğŸ’¡ï¼šä¸è¦é‡å¤æ¸²æŸ“ï¼Ÿ

æä¸€ä¸ª `_updated` ç§æœ‰å±æ€§

![ä¸è¦é‡å¤æ¸²æŸ“](assets/img/2021-02-27-15-55-13.png)

ğŸ’¡ï¼šæƒ³è¦è¿™ç§è°ƒç”¨æ–¹å¼ï¼š `app.data.a = 666` -> è§¦å‘ `render`

éœ€è¦è‡ªå·±å»é€’å½’å¤„ç† -> å¤„ç†ä¸å¥½å½±å“æ€§èƒ½ï¼Œå¤„ç†å¥½äº†ï¼Œä»£ç ä¸‘é™‹ï¼

![å¾ˆéº»çƒ¦](assets/img/2021-02-27-17-10-22.png)

2ï¼‰é‡å†™ HotList

ğŸ’¡ï¼š `constructor` é‡Œè¾¹ä¸è¦æé‚£ä¹ˆå¤šæ“ä½œï¼Œæœ‰ä»·å€¼çš„æ“ä½œå°±æå–å‡ºæ¥æˆä¸ºä¸€ä¸ªæ–¹æ³•ï¼

> åœ¨å†™æ–­è¨€çš„æ—¶å€™ï¼Œæ—¶å¸¸æ¥ä¸€å¥ï¼šæˆ‘è¿™è¦æ±‚è¿‡åˆ†å—ï¼Ÿ

``` js
class HotList {
  //parentè‡ªåŠ¨åˆ¤æ–­
  constructor(options) {
    assert(options, "optionså¿…é¡»æœ‰");
    // æŠŠéœ€è¦æå¾ˆå¤šæ–­è¨€çš„æ“ä½œæŠ½å‡ºå»
    this._root = this._getRoot(options);
    this._defineData(options);

    this.render();

    this._update = false;
  }

  _getRoot(options) {
    // æˆ‘è¿™è¦æ±‚è¿‡åˆ†å—ï¼Ÿ
    assert(options.root, "rootä¸èƒ½ä¸ºç©º");

    if (typeof options.root == "string") {
      let root = document.querySelector(options.root);
      assert(root, `æ‰¾ä¸åˆ°: ${options.root}`);

      return root;
    } else if (options.root instanceof HTMLElement) {
      return options.root;
    } else {
      assert(false, "rootä¸åˆæ³•");
    }
  }

  _defineData(options) {
    assert(options.data, `dataä¸èƒ½æ²¡æœ‰`);
    assert(typeof options.data == "function", `dataå¿…é¡»æ˜¯å‡½æ•°`);

    let data = options.data();
    assert(data, "dataå¿…é¡»æœ‰è¿”å›å€¼");
    assert(typeof data == "object", "dataå¿…é¡»æ˜¯object");

    //
    for (let name in data) {
      Object.defineProperty(this, name, {
        configurable: true,
        get() {
          return data[name];
        },
        set(val) {
          data[name] = val;

          this.render();
        },
      });
    }
  }

  // ä¿®æ”¹æ•°ç»„å…ƒç´ é‡Œè¾¹çš„å†…å®¹ï¼Œå¼ºåˆ¶ renderï¼
  $set(obj, name, val) {
    this._update = false;
    obj[name] = val;

    if (!this._update) {
      this.render();
    }
  }

  render() {
    let div = document.createElement("div");
    div.className = "v-hd";
    div.innerHTML = this.title;

    let ul = document.createElement("ul");
    ul.className = "user-list";

    let arr = [];
    this.data.forEach((data) => {
      arr.push(`
        <li class="row">
          <a href="${data.href}" class="cver">
            <img src="${data.avatar}" alt="">
          </a>
          <div class="info">
            <p class="row aic">
              <a href="${data.href}" class="nm-icn">${data.name}</a>
              ${data.vip ? '<img src="./img/vip.png" alt="">' : ""}
            </p>
            <p class="label">${data.title}</p>
          </div>
        </li>
      `);
    });
    ul.innerHTML = arr.join("");

    //
    this._root.innerHTML = "";
    this._root.appendChild(div);
    this._root.appendChild(ul);

    this._update = true;
  }
}

let list = new HotList({
  root: ".hot-host",
  data() {
    return {
      title: "çƒ­é—¨ä¸»æ’­",
      data: [{
          name: "blue",
          href: "http://www.zhinengshe.com/",
          avatar: "img/1407374893913311.jpg",
          vip: false,
          title: "æ‰“æ‚çš„",
        },
        {
          name: "blue",
          href: "http://www.zhinengshe.com/",
          avatar: "img/1407374893913311.jpg",
          vip: false,
          title: "æ‰“æ‚çš„",
        },
        {
          name: "blue",
          href: "http://www.zhinengshe.com/",
          avatar: "img/1407374893913311.jpg",
          vip: false,
          title: "æ‰“æ‚çš„",
        },
      ],
    };
  },
});
```

3ï¼‰Proxy

> defineProperty èƒ½ç”¨ï¼Œä½†å®ƒä¸é è°±ï¼Œä¸ºä½•ä¸ç”¨é è°±çš„ä¸œè¥¿å‘¢ï¼Ÿ

Proxy çš„å‰èº«æ˜¯ Observeï¼Œä½†å®ƒå·²ç»è¢«åºŸå¼ƒæ‰äº†ï¼

1ã€æ€ä¹ˆç”¨

1. å‡†å¤‡ä¸€ä¸ªçœŸå®æ•°æ® -> æ­¤æ•°æ®æ˜¯è¦è—åœ¨èƒŒåçš„ï¼Œä¸ä¼šè¢«äººå»ä¿®æ”¹
2. `new Proxy` -> ä»£ç†ï¼Œä½ æ‰¾ä»–æœ‰äº‹ï¼Ÿå…ˆè·Ÿæˆ‘è¯´å§ï¼

   1. ç¬¬ä¸€ä¸ªå‚æ•° -> æˆ‘è¦ç›‘å¬è°
   2. ç¬¬äºŒä¸ªå‚æ•° -> `{}` -> é‡Œè¾¹æä¾›äº†å¥½å‡ ç§æ–¹æ³•ï¼ŒåŸå…ˆçš„ `defineProperty` è¿‡äºå¤æ‚ï¼Œå–æ¶ˆæ‰äº†ä¸€äº›ä¸œè¥¿ -> ä»¥ä¸‹è¿™äº›å‡½æ•°éœ€è¦è¿”å›å€¼ï¼Œä¸ç„¶è¿”å› `undefined` çš„è¯ï¼Œå°±æ˜¯ `false` äº† -> å¯¹ä»£ç†åšæŸäº›æ“ä½œï¼Œä¼šè§¦å‘ä»¥ä¸‹ç›¸åº”çš„æŸäº›è¡Œä¸º

      1. has -> `xxx in {}` -> è¿”å›`ture/false` -> **`in`è§¦å‘**
      2. get -> è·å–
      3. set -> è®¾ç½®
      4. deleteProperty -> å¤„ç†delete -> ä¸å«deleteï¼Œæ˜¯ä»¥é˜²ä¸`delete`å…³é”®å­—é‡å -> **`delete`è§¦å‘**

         1. ä»å“ªå„¿åˆ 
         2. åˆ è°

åŸºæœ¬ä½¿ç”¨ï¼ˆæ²¡æœ‰è§£å†³ `arr` å€¼æ²¡æœ‰è¢«ç›‘å¬çš„é—®é¢˜ï¼‰ï¼š

``` js
//çœŸå®æ•°æ®
let _data = {
  a: 12,
  arr: [1, 2, 3],
  json: {
    a: 12,
    b: 5
  },
};

let p = new Proxy(_data, {
  has(data, name) {
    //in
    if (name in data) {
      return true;
    } else {
      return false;
    }
  },
  get(data, name) {
    //è·å–
    if (name in data) {
      return data[name];
    } else {
      throw new Error(`${name} is not defined`);
    }
  },
  set(data, name, val) {
    //è®¾ç½®
    console.log("set");
    data[name] = val;
  },
  deleteProperty(data, name) {
    //å¤„ç†delete
    if (name in data) {
      return delete data[name];
    } else {
      throw new Error(`${name} is not defined`);
    }
  },
});
```

è¿™ç©æ„å„¿ï¼Œç›®å‰åœ¨ç”¨æ³•ä¸Šæ˜¯ä¸æ–¹ä¾¿çš„ï¼å› ä¸ºä½ è¦ç›‘å¬ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½å¾— `new Proxy(_data,{})` è¿™æ ·åŒ…è£¹ä¸€å±‚ï¼

2ã€ä»‹ç»ä¸¤ä¸ªå¯¹å®ƒåœ¨ä½¿ç”¨ä¸Šè‡³å…³é‡è¦çš„ä¸œè¥¿

è·Ÿå‡½æ•°é…åˆï¼š

å¦‚ä½•æ‰èƒ½è·Ÿå‡½æ•°é…åˆï¼Ÿ

1. å‰ææ¡ä»¶ï¼šç›‘å¬çš„ä¸œè¥¿ä¹Ÿå¾—æ˜¯ä¸ªå‡½æ•°ï¼Œä¸ç”¨æˆ‘ä»¬æ— æ³•è°ƒç”¨`p` -> `new Proxy`çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å‡½æ•°çš„è¯ï¼Œé‚£ä¹ˆè¿”å›å€¼ä¹Ÿæ˜¯å‡½æ•°
2. ä½¿ç”¨ `apply` è¿™ä¸ªå‚æ•° -> `{has,apply}`

   1. `apply` æœ‰ä¸‰ä¸ªå‚æ•° -> `fn/thisValue/args`

> Proxy å®ƒä¸ä»…å¯ä»¥ç”¨æ¥åŒ…è£…ä¸€ä¸ªæ•°æ®ï¼Œè¿˜å¯ä»¥ç”¨æ¥åŒ…è£…ä¸€ä¸ªå‡½æ•°ï¼

![applyå‚æ•°](assets/img/2021-02-27-19-14-46.png)

ç›®å‰ï¼Œæˆ‘ä»¬è¯•äº† jsonï¼Œå‡½æ•°ï¼Œæ¥ä¸‹æ¥è¯•ä¸€ä¸‹æ•°ç»„ï¼

è·Ÿæ•°ç»„é…åˆï¼š

``` js
let _data = [1, 2, 3];

let p = new Proxy(_data, {
  get(data, name) {
    console.log("get");
    return data[name];
  },
  set(data, name, val) {
    console.log("set");
    data[name] = val;
  },
});
```

åœ¨`push`å…ƒç´ æ—¶ï¼Œ`set`æŠ¥é”™äº†ï¼š

![æŠ¥é”™](assets/img/2021-02-27-19-23-09.png)

è·Ÿç±»æ‰“äº¤é“ï¼š

> è¿™ä¸ªå¾ˆé‡è¦

`construct`ç”¨æ¥å¤„ç†`new`çš„ï¼åœ¨ä½ `new`çš„æ—¶å€™ï¼Œä¼šæ‹¦æˆªä½ è¿™ä¸ªæ“ä½œ -> è¿™å¯ä¸æ˜¯`constructor`

æ³¨æ„ç‚¹ï¼šä¸éœ€è¦ä¼ `this`ï¼Œå› ä¸º`new`çš„æ—¶å€™å°±ç¡®å®š`this`æ˜¯å®ä¾‹äº†ï¼

![é…åˆç±»](assets/img/2021-02-27-19-33-12.png)

å¦‚æœä½ ä¸è¿”å›ä¸€ä¸ª`{}/[]`ç­‰ï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥é”™ï¼š

![æŠ¥é”™](assets/img/2021-02-27-19-34-28.png)

3ã€å°ç»“

åˆ†æƒ…å†µä½¿ç”¨è¿™ 6 ä¸ªä¸œè¥¿ï¼š

- has -> in
- get -> è·å–
- set -> èµ‹å€¼ï¼ˆpushã€popç­‰æ“ä½œï¼Œå¾ˆå¤æ‚ï¼Œä¼šåŒæ—¶æ”¹åŠ¨å¤šä¸ªä¸œè¥¿ï¼‰
- deleteProperty -> åˆ é™¤ -> éœ€è¦è¿”å›`in`æ“ä½œçš„ç»“æœ
- apply -> å‡½æ•°è°ƒç”¨ -> åŸå…ˆé‚£ä¸ªå®šä¹‰å±æ€§APIæ˜¯æ— æ³•æ£€æµ‹å‡½æ•°è¢«è°ƒç”¨çš„ï¼
- construct -> new

4ï¼‰ç›‘å¬ä¸€ä¸ª`class`é‡Œè¾¹æ‰€æœ‰çš„å±æ€§

ä¸€æ—¦å±æ€§è¢«æ”¹åŠ¨äº†ï¼Œå°±å¾—æ”¶åˆ°é€šçŸ¥ï¼

ç›‘å¬å¯¹è±¡ï¼š

![class](assets/img/2021-02-27-19-58-18.png)

ç”¨æˆ·åœ¨ä½¿ç”¨æ—¶ä¸æ–¹ä¾¿ -> éœ€è¦ç”¨`let a = new Proxy()`è¿™æ ·åŒ…è£¹ä¸€å±‚ä½¿ç”¨`a`å®ä¾‹

ç›‘å¬ç±»ï¼ˆç±»ä¼¼é«˜é˜¶ç±»ï¼‰ï¼š

![ç›‘å¬ç±»](assets/img/2021-02-27-20-06-22.png)

---

è¿™ä¸¤ç§å§¿åŠ¿ï¼Œæ˜¾ç„¶åè€…å¥½ï¼`Proxy` ç›¸è¾ƒäº `Object.defineProperty`ï¼š

1. å¼ºå¤§å¤šäº† -> å¤šäº†å¥½å¤šåŠŸèƒ½
2. ä¹Ÿå¤šäº†å¾ˆå¤šå¤æ‚ -> ç”¨èµ·æ¥è¦æ›´å¤æ‚ä¸€äº›

5ï¼‰ä¾‹å­

> é€è¿‡ä¾‹å­ï¼Œè¿›ä¸€æ­¥æ·±å…¥ç†è§£è¿™ä¸ª`Proxy`













